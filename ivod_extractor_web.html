<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç«‹æ³•é™¢ IVOD å½±ç‰‡æ“·å–å·¥å…·ï¼ˆç©©å®šç‰ˆï¼‰</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f8f9fa;
    padding: 2rem;
    max-width: 720px;
    margin: auto;
  }
  h2 { color: #0d6efd; }
  input, button {
    width: 100%;
    padding: 0.75rem;
    margin-bottom: 1rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  button { background: #0d6efd; color: white; border: none; cursor: pointer; }
  button:hover { background: #0b5ed7; }
  pre {
    background: #f1f3f5;
    padding: 1rem;
    border-radius: 8px;
    white-space: pre-wrap;
    word-break: break-all;
  }
  .actions { display: flex; gap: 0.5rem; }
  .actions button { flex: 1; }
  .tip {
    background: #fff3cd;
    border: 1px solid #ffe69c;
    color: #8a6d3b;
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
</style>
</head>
<body>
  <h2>ğŸ¥ ç«‹æ³•é™¢ IVOD å½±ç‰‡æ“·å–å·¥å…·ï¼ˆç©©å®šç‰ˆï¼‰</h2>
  <div class="tip">
    âš ï¸ è‹¥å‡ºç¾ <b>ERR_QUIC_PROTOCOL_ERROR</b> æˆ– <b>Failed to fetch</b>ï¼š<br>
    1ï¸âƒ£ åœç”¨ QUICï¼ˆ<code>chrome://flags/#enable-quic</code> â†’ Disabledï¼‰<br>
    2ï¸âƒ£ æ”¹ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿæœ¬é ï¼ˆä¾‹ï¼š<code>python -m http.server 5500</code>ï¼‰<br>
    3ï¸âƒ£ æœ¬å·¥å…·å…§å«å¤šä»£ç†åˆ‡æ›æ©Ÿåˆ¶ï¼Œå¯è‡ªå‹•å˜—è©¦ä¸åŒ API ä¾†æº
  </div>

  <input id="url" type="text" placeholder="ä¾‹å¦‚ï¼šhttps://ivod.ly.gov.tw/Play/Clip/1M/163842" />
  <div class="actions">
    <button id="extractBtn">æ“·å–å½±ç‰‡é€£çµ</button>
    <button id="clearBtn">æ¸…é™¤çµæœ</button>
  </div>

  <pre id="output">ç­‰å¾…è¼¸å…¥ç¶²å€...</pre>
  <div class="actions" id="extraButtons" style="display:none">
    <button id="copyLinkBtn">ğŸ“‹ è¤‡è£½ m3u8 é€£çµ</button>
    <button id="copyCmdBtn">ğŸ’» è¤‡è£½ MP4 ä¸‹è¼‰æŒ‡ä»¤</button>
    <button id="copyAudioBtn">ğŸ§ è¤‡è£½ MP3 è½‰æª”æŒ‡ä»¤</button>
    <button id="openVideoBtn">â¬‡ï¸ ç›´æ¥é–‹å•Ÿå½±ç‰‡</button>
  </div>

  <script type="text/javascript">
    console.log('âœ… extract script loaded');

    let currentM3u8 = '', currentCmd = '', currentAudioCmd = '';

    const PROXIES = [
      (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
      (url) => `https://thingproxy.freeboard.io/fetch/${url}`,
      (url) => `https://cors.isomorphic-git.org/${url}`,
      (url) => `https://r.jina.ai/http://${url.replace(/^https?:\/\//, '')}`
    ];

    async function tryProxies(url) {
      for (const build of PROXIES) {
        try {
          const resp = await fetch(build(url));
          if (!resp.ok) continue;
          const text = await resp.text();
          if (text.includes('.m3u8')) return text;
        } catch (err) { continue; }
      }
      throw new Error('æ‰€æœ‰ä»£ç†çš†å¤±æ•—æˆ–ç„¡æ³•å­˜å–å½±ç‰‡å…§å®¹ã€‚');
    }

    async function extract() {
      const url = document.getElementById('url').value.trim();
      const output = document.getElementById('output');
      const extraButtons = document.getElementById('extraButtons');
      if (!url) { output.textContent = 'âš ï¸ è«‹å…ˆè¼¸å…¥ç¶²å€'; return; }
      output.textContent = 'â³ æ­£åœ¨æ“·å–ä¸­ï¼ˆå¤šä»£ç†ä¸­...ï¼‰';
      extraButtons.style.display = 'none';

      try {
        const text = await tryProxies(url);
        const match = text.match(/https[^\"']+\.m3u8/g);
        if (match && match.length > 0) {
          currentM3u8 = match[0];
          currentCmd = `ffmpeg -i \"${currentM3u8}\" -c copy output.mp4`;
          currentAudioCmd = `ffmpeg -i \"${currentM3u8}\" -vn -acodec libmp3lame -ab 192k output.mp3`;
          output.textContent = `âœ… æ‰¾åˆ°å½±ç‰‡ä¸²æµï¼š\n${currentM3u8}\n\nğŸ’» MP4 ä¸‹è¼‰æŒ‡ä»¤ï¼š\n${currentCmd}\n\nğŸ§ MP3 è½‰æª”æŒ‡ä»¤ï¼š\n${currentAudioCmd}`;
          extraButtons.style.display = 'flex';
        } else {
          output.textContent = 'âŒ æœªæ‰¾åˆ° .m3u8 ä¸²æµé€£çµï¼Œå¯èƒ½è©²é å½±ç‰‡æœªé–‹æ”¾æˆ–æ ¼å¼ä¸åŒã€‚';
        }
      } catch (err) {
        output.textContent = `âŒ æ“·å–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}`;
      }
    }

    function clearOutput() {
      document.getElementById('output').textContent = 'ç­‰å¾…è¼¸å…¥ç¶²å€...';
      document.getElementById('extraButtons').style.display = 'none';
      currentM3u8 = currentCmd = currentAudioCmd = '';
    }

    function copyLink() {
      if (currentM3u8) navigator.clipboard.writeText(currentM3u8);
      alert('âœ… å·²è¤‡è£½ m3u8 é€£çµ');
    }

    function copyCommand() {
      if (currentCmd) navigator.clipboard.writeText(currentCmd);
      alert('âœ… å·²è¤‡è£½ MP4 ffmpeg æŒ‡ä»¤');
    }

    function copyAudioCommand() {
      if (currentAudioCmd) navigator.clipboard.writeText(currentAudioCmd);
      alert('âœ… å·²è¤‡è£½ MP3 è½‰æª”æŒ‡ä»¤');
    }

    function downloadVideo() {
      if (currentM3u8) window.open(currentM3u8, '_blank');
    }

    // ç¶å®šæŒ‰éˆ•äº‹ä»¶
    document.getElementById('extractBtn').addEventListener('click', extract);
    document.getElementById('clearBtn').addEventListener('click', clearOutput);
    document.getElementById('copyLinkBtn').addEventListener('click', copyLink);
    document.getElementById('copyCmdBtn').addEventListener('click', copyCommand);
    document.getElementById('copyAudioBtn').addEventListener('click', copyAudioCommand);
    document.getElementById('openVideoBtn').addEventListener('click', downloadVideo);
  </script>
</body>
</html>
